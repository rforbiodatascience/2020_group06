---
title: "presentation_group06"
author: "Sebastian Sbirna, Sule Altinas & Stanley Frederiksen"
date: "14 May 2020"
output:
  ioslides_presentation:
    widescreen: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library("imager")
library("cowplot")
library("magick")
library("tidyverse")
library("imager")
```

## Introduction

At the end of December 2019, __COVID19__ (also known as SARS-CoV-2) coronavirus was first identified to be outbreaking in Wuhan, China. The virus continued to spread rapidly across the whole area of China, and later on, in some regions of Europe as well. 

On the day of __11 March 2020__, the World Health Organization (WHO) had acknowledged the fast spreading and major health risks of the COVID19 outbreak, and have classified it as a *__pandemic__*. The world has been majorly affected, with the deepest outbreaks in China, USA and Italy.


Some questions that one can immediately ask are: 

- **How quickly did the virus spread across the globe?**
- **Can we see any effect from country-wide policies that various countries have implemented, such as shutdowns and quarantines?**


## Introduction

From expert analysis and clinical information, we know that COVID19 spreads through *__respiratory droplets__*, such as when sneezing, coughing or speaking. 

Organizations and researchers across the whole world have been collecting data for monitoring and learning about this pandemic. Notably, the **Johns Hopkins University** created a publicly available data repository to consolidate research efforts. 

## Introduction

Our project has used a modified version of this data, which is available from Kaggle: <https://www.kaggle.com/sudalairajkumar/novel-corona-virus-2019-dataset>, by _Sudalai Rajkumar_, which consists of both patient data from the first 2 months of the outbreak with time-series data about the spread of the virus.

Please note that infection spreading information and data regarding COVID19 is being updated every day. The data used for this project was first pulled on 15 April 2020, and has been updated accordingly since then. __The last update of the data was done on 13 May 2020.__


## Introduction
### The dataset
<br>
Our project has used a modified version of this data, which is available from Kaggle: <https://www.kaggle.com/sudalairajkumar/novel-corona-virus-2019-dataset>, by _Sudalai Rajkumar_, which consists of:

* patient data from the first 2 months of the outbreak 
* time-series data about the spread of the virus

Please note that infection spreading information and data regarding COVID19 is being updated every day. The data used for this project was first pulled on 15 April 2020, and has been updated accordingly since then. 

*__The last update of the data was done on 13 May 2020.__*


## Biological insights

- How does the COVID-19 affect each gender?

- Which symptoms are we likely to observe among the patients?

- Can we predict the patient's progression?


## Heatmap of confirmed cases

Status of the COVID-19 confirmed cases in the world

- Observed from January-February 2020

```{r fig.align="center"}

heatmap_confirmed <- load.image("../results/heatmap_confirmed.png")

ggdraw() +
  draw_image(heatmap_confirmed, scale = 1,
  clip = "on")

# clip = "on", is a funcition that draws the image into the "container/box" generated by ggdraw.

```

## Methodology
### Data Import

* This modified version of the JHU dataset initially contained 9 "untidy" dataframes:
  * `covid_19_data.csv`: daily information on confirmed, recovered and deceased patients
  * `COVID19_line_list_data.csv`: first patient data file, with ~1000 records
  * `COVID19_open_line_list.csv`: second patient data file, with ~10000 records
  * `time_series_covid_19_confirmed.csv`: daily number of confirmed cases around the world 
  * `time_series_covid_19_confirmed_US.csv`: daily number of confirmed cases only for US and its states
  * `time_series_covid_19_deaths.csv`: daily number of deceased cases around the world
  * `time_series_covid_19_deaths_US.csv`: daily number of deceased cases only for US and its states
  * `time_series_covid_19_recovered.csv`: daily number of recovered cases around the world
  * `wpp2019_total_population.csv`: data downloaded from <https://population.un.org/wpp/Download/Standard/CSV/> which has the total population of a country in 2019
  
  
## Methodology
### Data Wrangling

* All these dataframes were very dirty
  * Different number and type of attributes
  * Different formats for storing country & provinces
  * Different methodology of collecting time-series data
  * Empty and extremely sparse columns
  * Conceptual string duplicates (e.g. _runny nose_ and _nasal discharge_ )
  * ... and more
  
  
## Methodology
### Data Wrangling

Heavy data wrangling & tidying procedures were necessary, in order to achieve consistency across the different datasets:

* ___Column renaming to a common scheme___
* ___Remove data inconsistencies in province and country strings___
* ___Transformation of missing values to a common format___
* ___Empty and unnecessary column removal___
* ___Replace conceptual duplicates in the patient symptom data___
* ___Fixing erroneous age values___
* ___Date conversion into a unitary format___
* ___Tidying time-series dataset into long format (date column)___
* ___Tidying patient data into wide format (symptoms column)___
  
  
## Methodology
### _How did we achieve data wrangling?_
* Very heavy use of `stringr` and __`regexp (regular expressions)`__
* `dplyr` to the rescue - filtering, mutating, grouping, summarizing
* `tidyr` for reshaping tibbles into __wide/long format__
* `lubridate` for __dates conversion__
* `readr` for reading and saving CSV files easily
* Achieved a consistent andn easy-to-understand workflow through _piping_ (`%>%`)


## Methodology
### Data Augmentation

After cleaning the data, we augmented it by manipulating it to create new, useful columns:

* ___Created categorical age groups for patients___
* ___Joined together the two patient dataframes into one___
* ___Joined together the three time-series world dataframes (confirmed, recovered,deaths) into one___
* ___Augmented the Time-Series data with total population numbers___
  * ___Computed proportion of population infected per 1 million inhabitants___
  * ___Computed daily new infections, recovered and deaths from the time-series data___
  
  
## Methodology
### _How did we achieve data augmentation?_
* Heavy use of `dplyr` for joining dataframes, mutating and filtering
* `tidyr` for reshaping tibbles into __wide/long format__
* `forcats` for ordering categorical variables
* `readr` for reading and saving CSV files easily


# Methods

## Fitting beta and gamma to the data
How to find the optimal values of $\beta$ and $\gamma$?

One answer: Minimize the residual square error (RSS) between the observed number of infections and the predicted.

For this, we need:

- A way to solve the ODEs: function ode() from R package deSolve
- An optimizer: built-in R function optimize()


# Descriptive

## Which countries are most affected

*China is excluded
*Plot shows only when observed more than 100 cases

```{r fig.align="center"}

cases_above_hundred <- load.image("../results/cases_above_hundred.png")

ggdraw() +
  draw_image(cases_above_hundred, scale = 1,
  clip = "on")

```



## Data distribution among age and gender

- Mostly male patients are affected
- Most occuring ages among the affected are between 30-59 years old

```{r fig.align="center"}

distribution_age_group_gender <- load.image("../results/distribution_age_group_gender.png")

ggdraw() +
  draw_image(distribution_age_group_gender, scale = 1,
  clip = "on")

```



## Differences in age

- Older people are likely to die
- Only (male) patients without contact with Wuhan died while having dyspnea

```{r fig.align="center"}

age_symptoms_death_wuhan <- load.image("../results/age_symptoms_death_wuhan.png")

ggdraw() +
  draw_image(age_symptoms_death_wuhan, scale = 1,
  clip = "on")

```

# Symptoms


## Prevalence of symptoms

- fever, cough and sore throat are the most frequent symptoms observed among the patients

```{r fig.align="center"}

Prevalence_symptoms <- load.image("../results/Prevalence_symptoms.png")

ggdraw() +
  draw_image(Prevalence_symptoms, scale = 1,
  clip = "on")

```

## Comorbidity of symptoms

- When having fever, the patiens were also likely to have cough, dyspnea, fatigue, malaise and sore throat

```{r fig.align="center"}

symptoms_comorbidity <- load.image("../results/05_symptoms_comorbidity.png")

ggdraw() +
  draw_image(symptoms_comorbidity, scale = 1.1,
  clip = "on")

```


## Correlation of symptoms

- Cough and fever have the highest correlation ~0.5

```{r fig.align="center"}

symptoms_corr_heatmap <- load.image("../results/05_symptoms_corr_heatmap.png")

ggdraw() +
  draw_image(symptoms_corr_heatmap, scale = 1.1,
  clip = "on")

```


## Symptoms, dead vs. recovered patients

- Fever was most prevalent among the recovered but cough was more represented among the dead patients

```{r fig.align="center"}

symptoms_dead_or_recovered <- load.image("../results/05_symptoms_dead_or_recovered.png")

ggdraw() +
  draw_image(symptoms_dead_or_recovered, scale = 0.9,
  clip = "on")

```


## Symptoms in selected asian countries

- Other symptoms (fatigue, sore throat, headache etc.) was more frequently observed in Japan compared to other countries. South Korea observed only fever

```{r fig.align="center"}

symptoms_per_country <- load.image("../results/05_symptoms_per_country.png")

ggdraw() +
  draw_image(symptoms_per_country, scale = 0.9,
  clip = "on")

```


## Propotion of symptoms by gender

- Muscle pain, joint pain and diarrhea were only observed among the male patients

```{r fig.align="center"}

symptoms_per_gender <- load.image("../results/05_symptoms_per_gender.png")

ggdraw() +
  draw_image(symptoms_per_gender, scale = 1,
  clip = "on")

```



# Time series


## Time to admission

- The time from experiencing symptoms to hospitalization does not tend to differ whether the patient have been in contact with Wuhan or not.

```{r fig.align="center"}

onset_to_admission <- load.image("../results/onset_to_admission.png")

ggdraw() +
  draw_image(onset_to_admission, scale = 1,
  clip = "on")

```


## Total confirmed cases per million population

*selected countries

- Sweden have most confirmed cases and Philippines have the least cases

```{r fig.align="center"}

confirmed_per_mill <- load.image("../results/confirmed_per_mill.png")

ggdraw() +
  draw_image(confirmed_per_mill, scale = 1,
  clip = "on")
  

```


## Total death cases per million population

- Romania and Turkey have approx. the same counts of deaths per million population

```{r fig.align="center"}

deaths_per_mill <- load.image("../results/deaths_per_mill.png")

ggdraw() +
  draw_image(deaths_per_mill, scale = 1,
  clip = "on")

```


## Total confirmed and death cases per million population, DK vs. SE

- There is a higher tendency to die if you are from Sweden

```{r fig.align="center"}

confirmed_death_per_mil_pop <- load.image("../results/confirmed_death_per_mil_pop.png")

ggdraw() +
  draw_image(confirmed_death_per_mil_pop, scale = 1,
  clip = "on")

```


# Linear Models

## Linear regression model of the 5 countries (confirmed cases)

- All coefficients are significant

```{r fig.align="center"}

table_df_ts_models_stats <- load.image("../results/table_df_ts_models_stats.png")

ggdraw() +
  draw_image(table_df_ts_models_stats, scale = 1,
  clip = "on")

```


## Model evaluation of the confirmed cases

- Sweden with the highest rate of confirmed cases

```{r fig.align="center"}

model_eval_confirmed <- load.image("../results/model_eval_confirmed.png")

ggdraw() +
  draw_image(model_eval_confirmed, scale = 1,
  clip = "on")

```


## Model evaluation of the death cases

- Sweden have almost 3 times higher death rate compared to Denmark

```{r fig.align="center"}

model_eval_death <- load.image("../results/model_eval_death.png")

ggdraw() +
  draw_image(model_eval_death, scale = 1,
  clip = "on")

```



## Model evaluation: Residuals

- The model residuals for the death cases have approx. zero mean and constant variance, which is not the case for the confirmed cases.

```{r fig.align="center"}

model_eval_residuals <- load.image("../results/model_eval_residuals.png")

ggdraw() +
  draw_image(model_eval_residuals, scale = 1,
  clip = "on")

```

# SIR models

## Modelling the COVID-19 pandemic: SIR

```{r,  out.width =  "800px", fig.align = 'center'}
knitr::include_graphics("../img/SIR.png")
```
$$\frac{dS}{dt} = \beta\cdot S\cdot I $$
$$\frac{dS}{dt} = \beta\cdot S\cdot I $$
$$\frac{dR}{dt} = \gamma*I $$

## Observed cases in Denmark
```{r,  out.width =  "700", fig.align = 'center'}
knitr::include_graphics("../results/04_Denmark_obs.png")
```

## Observed cases in Scandinavia
```{r,  out.width =  "580px", fig.align = 'center'}
knitr::include_graphics("../results/04_scandinavia_obs.png")
```

## Resulting parameters: Sweden

Optimized values were found to $\beta = 0.56$ and $\gamma = 0.44$

giving a reproductive rate of $R_0 = 1.25$

```{r,  out.width =  "580px", fig.align = 'center'}
knitr::include_graphics("../results/04_sweden_obs_vs_fit.png")
```

## Making predictions

```{r,  out.width =  "700", fig.align = 'center'}
knitr::include_graphics("../results/04_sweden_pred.png")
```


# Dimensional reduction and Machine Learning

## PCA

- The first three PCs account for ~60% of the total variance

```{r fig.align="center"}

pca_biological_features <- load.image("../results/pca_biological_features.png")

ggdraw() +
  draw_image(pca_biological_features, scale = 1,
  clip = "on")

```


## Predicting patient progression

- Training and test set (80/20), plot performed on the training set
- If you have been in contact with Wuhan and your age is equal to or above 73 years old, the probability of being dead is 92%

```{r fig.align="center"}

df_patient_dec_fit <- load.image("../results/df_patient_dec_fit.png")

ggdraw() +
  draw_image(df_patient_dec_fit, scale = 1,
  clip = "on")

```


## Evaluation of the decision tree

- Rows are the true classes and the columns are the predicted classes
- Accuracy = 97.6%

```{r fig.align="center"}

table_cm_plot <- load.image("../results/table_cm_plot.png")

ggdraw() +
  draw_image(table_cm_plot, scale = 1,
  clip = "on")

```


# Summary

## Discussion

- Males are overrepresented among the patients
- Symptoms caused by COVID-19 resemble influenza (fever, cough, sore throath etc.)
- Death is merely due to age, while recovery may depend on experienced symptoms
- Community/political actions can have an affect on infection, which can be seen between Denmark and Sweden (two comparable nations)
- Linear model may not be appropriate for the confirmed cases but works well for the death cases
- It may not be an advantage to reduce the dimension of the data set with PCA
- Decision tree is suitable and interpretable for predicting patient progression

## Challenges

- We were not able to find a suitable function to save the plots of the heatmap and decision tree. This was done manually by export
- Multiple errors occured when using github, reverting was necessary a couple of times
